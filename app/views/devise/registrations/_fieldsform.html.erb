<%= fields_for :person, resource.person do |person_fields| %>
  <% if resource.person.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(person.errors.count, "error") %> prohibited this person from being saved:</h2>

      <ul>
        <% resource.person.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="field mb-3 edit-profile-picture">
    <%= person_fields.label :profile_picture, class: 'form-label' %>
    <div class='profile-picture-wrapper'>
      <div class='profile-picture-container'>
        <% if resource.person.profile_picture.attached? %>
          <img src="<%= (url_for(person.profile_picture)) %>" alt="<%= resource.person.profile_picture.filename %>"/>
        <% else %>
          <img src="<%= (url_for('/assets/default-profile-picture.png')) %>" alt="default-profile-picture">
        <% end %>
      </div>
      <button class='edit-btn' onclick="event.preventDefault(); $('input[type=file]').click()">
        <i class="fa fa-pen" aria-hidden="true"></i></button>
    </div>
    <%= person_fields.file_field :profile_picture, class: 'form-control', accept: 'image/png,image/jpeg' %>
  </div>

  <div class="field mb-3">
    <%= person_fields.label :first_name, class: 'form-label' %>
    <%= person_fields.text_field :first_name, class: 'form-control' %>
  </div>
  <div class="field mb-3">
    <%= person_fields.label :last_name, class: 'form-label' %>
    <%= person_fields.text_field :last_name, class: 'form-control' %>
  </div>

  <div class="field mb-3">
    <%= person_fields.label :phone_number, class: 'form-label' %>
    <%= person_fields.text_field :phone_number, class: 'form-control' %>
  </div>

  <div class="field mb-3">
    <%= person_fields.label :email, class: 'form-label' %>
    <%= person_fields.text_field :email, class: 'form-control' %>
  </div>

  <div class="field mb-3">
    <%= person_fields.label :rooms, class: 'form-label' %><br/>
    <%= person_fields.select 'room_ids',
                             options_from_collection_for_select(Room.all, :id, :name, resource.person.room_ids),
                             {},
                             multiple: true %>
  </div>

  <div class="field mb-3 opening-times-container">
    <%= person_fields.label :openingtimes, class: 'form-label' %>
    <%= person_fields.fields_for :openingtimes do |o| %>
      <div class="field" id="opening-time-field-<%= o.object.id %>">
        <%= o.select 'day',
                     options_for_select({ 'Monday' => 0,
                                          'Tuesday' => 1,
                                          'Wednesday' => 2,
                                          'Thursday' => 3,
                                          'Friday' => 4,
                                          'Saturday' => 5,
                                          'Sunday' => 6
                                        }, o.object.day),
                     {},
                     multiple: false %>
        <%= o.time_field :opens, value: o.object.opens %>
        <span>-</span>
        <%= o.time_field :closes, value: o.object.closes %>
        <%= link_to(openingtime_path(o.object.id), :method => :delete, :class => 'btn btn-mini',
                    :remote => true, :onclick =>
                      "{$('#opening-time-field-#{o.object.id}').next().remove();
                       $('#opening-time-field-#{o.object.id}')[0].remove()}") do %>
          <i class="fas fa-trash"></i>
        <% end %>
      </div>
    <% end %>
    <button class="btn" onclick="event.preventDefault(); addNewOpeningTime(this);"><i class="fas fa-plus"></i> Add
      opening time
    </button>
  </div>



  <script defer>
      $('input[name="user[profile_picture]"]').change(function () {
          const file = $(this).prop('files')[0] || null;
          if (!file) {
              return;
          }
          const url = URL.createObjectURL(file);
          $('.profile-picture-container img').prop('src', url);
          $('.profile-picture-container img').prop('alt', file.name);
      })

      const addNewOpeningTime = (target) => {
          $(`<div class="field" id="opening-time-field-new">
           <select name="person[openingtimes_attributes][-1][day]" id="opening-time-field-new">
                  <option value="0">Monday</option>
                  <option value="1">Tuesday</option>
                  <option value="2">Wednesday</option>
                  <option value="3">Thursday</option>
                  <option value="4">Friday</option>
                  <option value="5">Saturday</option>
                  <option value="6">Sunday</option></select>
           <input type="time" name="person[openingtimes_attributes][-1][opens]" id="opening-time-field-new">
           <span>-</span>
           <input type="time" name="person[openingtimes_attributes][-1][closes]" id="opening-time-field-new">
           </div>`).insertBefore(target);
          target.remove();
      }
  </script>

<% end %>

